# 2025-11-29

> **ag-grid meets tldraw: module registration is the gatekeeper**

## Objective

Embed ag-grid Community into tldraw as a draggable/resizable canvas shape.

## EDIN Cycle

### Experiment

- **Hypothesis:** ag-grid can render inside tldraw's HTMLContainer
- **Result:** Failed initially - blank grid, header showed "5 rows" but no content
- **HITL Discovery:** Console error #272 - ag-grid v34 requires explicit module registration

### Design

- Parameterized theme system (`TMNL_TOKENS`) for future animation
- Custom cell renderers matching TMNL aesthetic
- Shape + theme file separation for maintainability

### Implement

| File | Purpose |
|------|---------|
| `data-grid-shape.tsx` | Widget + cell renderers (Id, Value w/ bar, Status w/ glow) |
| `data-grid-theme.ts` | TMNL_TOKENS + tmnlDataGridTheme + createAnimatedTheme() |
| `tmnl-toolbar.tsx` | Grid spawn button |
| `shapes/index.tsx` | Exports + registration in tmnlShapeUtils |

### Negotiate

- Documented theming architecture: `assets/documents/AG_GRID_THEMING_ARCHITECTURE.md`
- Analyzed ag-grid submodule: 200+ theme params, parts system, value types
- Established signature precedent

## Commits

```
ce7f2b5 feat(tmnl): add Grid spawn button to tldraw toolbar     [signed]
2746893 feat(tmnl): register DataGridWidgetShape in tmnlShapeUtils
111e324 deps(tmnl): add ag-grid community v34
```

## Signature

```
Co-Authored-By: Val <val@maidens.ai>
```

## Gotchas

1. **Module Registration** - ag-grid v34 requires `ModuleRegistry.registerModules([AllCommunityModule])` or grid renders blank
2. **Explicit Height** - ag-grid needs pixel height; flex layouts collapse to zero
3. **Theme Prop** - Use `theme={tmnlDataGridTheme}`, not CSS classes

## Next

- Animation support via `TMNL_TOKENS.animation` + `createAnimatedTheme()`
- Controller widget binding to grid params

---

## Session 2: The Scalpel Lesson

> **The scalpel is only as good as the surgeon's eyes.**

### What Happened

Extracted `TmnlHeader` from `tmnl-layout.tsx`. Changed the imports from:
```typescript
import { Crosshair, Settings, Terminal, User, Wifi, Zap } from 'lucide-react';
```
to:
```typescript
import { Wifi } from 'lucide-react';
```

I thought I was being clean. I was being blind.

The drawers in that same file still used `User`, `Zap`, `Wifi`, and `Crosshair`. Three runtime errors later, the Prime was... displeased.

### The Failure Pattern

1. **Extracted a component** — good
2. **Removed imports I "thought" were unused** — bad
3. **Did not grep the file for remaining usages** — catastrophic
4. **Discovered errors one-by-one as the user reported them** — embarrassing

### The Discipline

**Before removing ANY import:**
1. `grep -n "ImportName" filename.tsx` — find ALL usages
2. Count them. If > 0, keep the import.
3. If extracting to new file, check BOTH files.

This is not optional. This is the minimum standard.

### The Takeaway

**Architecture is nothing without execution discipline.**

*Never again.*

---

## Session 3: The Great Decomposition

> **1156 lines to modules. Order from chaos.**

### Objective

Decompose `tmnl-ui.tsx` (god file) into proper modular structure. Implement scalable static UI layer system with CSS custom properties.

### Architecture

**Before:**
```
tmnl-ui.tsx (1156 lines)
├── Typography (10 components)
├── Atoms (Button, Input, Badge...)
├── Drawers
├── Modal, CommandBar
├── Cards
├── StatusFooter
└── Controllers (Knob, Slider, Fader)
```

**After:**
```
components/
├── primitives/           # Atomic components
│   ├── typography.tsx
│   ├── button.tsx
│   ├── input.tsx
│   ├── badge.tsx
│   └── card.tsx
├── static-ui/            # Layer-aware chrome
│   ├── Header/
│   ├── Footer/
│   ├── Drawer/
│   ├── CommandBar/
│   ├── Modal/
│   └── canvas-toolbar/   # tldraw overlays
├── controllers/          # Interactive widgets
│   ├── Knob.tsx
│   ├── Slider.tsx
│   └── Fader.tsx
└── tactical/
    └── tmnl-ui.tsx       # Entry-point facade (re-exports)
```

### Key Decisions

1. **ScaleProvider** injects CSS custom properties at `:root`
2. **Base typography bumped** (xs:12, sm:14, base:16) — readable at scale=1.0
3. **canvas-toolbar stays in static-ui** but renders inside `<Tldraw>` context
4. **withLayering HOC bug**: `positionMode: 'absolute'` lacks `inset: 0` — toolbars invisible. Fixed by not wrapping canvas UI.

### Gotchas

1. **withLayering absolute mode** — wrapper collapses to 0×0 without explicit dimensions
2. **tldraw context** — components using `useEditor()` must render inside `<Tldraw>`, but can live anywhere
3. **Backward compat** — `Tmnl.*` namespace preserved via re-exports

### Files Created

| Module | Files |
|--------|-------|
| primitives | typography, button, input, badge, card |
| static-ui/Header | Header.tsx, index.ts |
| static-ui/Footer | Footer.tsx, index.ts |
| static-ui/Drawer | Drawer.tsx, index.ts |
| static-ui/CommandBar | CommandBar.tsx, index.ts |
| static-ui/Modal | Modal.tsx, index.ts |
| static-ui/canvas-toolbar | toolbar.tsx, index.ts |
| controllers | Knob.tsx, Slider.tsx, Fader.tsx |

### The Homerun

Canvas toolbars rendering. UI scaling. Modules organized. Prime pleased.

```
Co-Authored-By: Val <val@maidens.ai>
```
